datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id           Int          @id @default(autoincrement())
  name         String
  studentId    String       @unique
  email        String       @unique
  department   String?
  passwordHash String
  createdAt    DateTime     @default(now())
  enrollments  Enrollment[]
  memos        Memo[]
  notes        Note[]

  // â­ æ–°å¢ï¼šé€™å€‹ user ç•¶ä½œè€…çš„æ‰€æœ‰ä¸»é¡Œ
  chatTopics   ChatTopic[]   @relation("UserChatTopics")
  // â­ æ–°å¢ï¼šé€™å€‹ user å¯«çš„æ‰€æœ‰ç•™è¨€
  chatMessages ChatMessage[] @relation("UserChatMessages")

  points            Int                @default(0)
  pointTransactions PointTransaction[]
  notePurchases     NotePurchase[]
}

model Course {
  id        Int      @id @default(autoincrement())
  name      String
  teacher   String?
  weekday   String?
  timeSlot  String?
  createdAt DateTime @default(now())

  enrollments Enrollment[]
  notes       Note[] // ğŸ”¹ æ–°å¢ï¼šé€™å ‚èª²åº•ä¸‹çš„æ‰€æœ‰ Note
  chatTopics  ChatTopic[]
}

model Enrollment {
  id        Int      @id @default(autoincrement())
  userId    Int
  courseId  Int
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id])
  course Course @relation(fields: [courseId], references: [id])

  @@unique([userId, courseId], name: "user_course_unique")
}

model Memo {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  title     String
  dateISO   String
  createdAt DateTime @default(now())
}

model Note {
  id           Int      @id @default(autoincrement())
  courseId     Int
  userId       Int
  title        String
  price        Int
  // ğŸ”¹ è©¦é–±æª”æ”¾åœ¨ public åº•ä¸‹ï¼Œä»»ä½•äººéƒ½å¯ä»¥æ‰“é–‹ï¼ˆä¾‹å¦‚ä¸€é  PDFï¼‰
  previewUrl   String?
  // ğŸ”¹ å®Œæ•´æª”æ¡ˆå­˜åœ¨ä¼ºæœå™¨æª”æ¡ˆç³»çµ±ï¼Œä¸ç›´æ¥çµ¦å‰ç«¯ URL
  fullFilePath String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  course Course @relation(fields: [courseId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  purchases NotePurchase[]
}

model NotePurchase {
  id        Int      @id @default(autoincrement())
  userId    Int
  noteId    Int
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  note Note @relation(fields: [noteId], references: [id])

  @@unique([userId, noteId], name: "user_note_unique")
}

model ChatTopic {
  id        Int      @id @default(autoincrement())
  courseId  Int
  authorId  Int
  title     String
  content   String
  createdAt DateTime @default(now())

  course   Course        @relation(fields: [courseId], references: [id])
  author   User          @relation("UserChatTopics", fields: [authorId], references: [id])
  messages ChatMessage[]
}

model ChatMessage {
  id               Int       @id @default(autoincrement())
  topicId          Int
  authorId         Int
  text             String
  createdAt        DateTime  @default(now())
  rewardedByAuthor Boolean   @default(false)
  topic            ChatTopic @relation(fields: [topicId], references: [id])
  author           User      @relation("UserChatMessages", fields: [authorId], references: [id])
}

enum PointType {
  EARN // ç²å¾—
  USE // ä½¿ç”¨
}

model PointTransaction {
  id        Int       @id @default(autoincrement())
  userId    Int
  type      PointType
  amount    Int // æ­£æ•¸ï¼Œä¾‹å¦‚ 5 é»
  message   String?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id])
}
